<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Analytics</title>
  <link rel="stylesheet" href="../assets/app.css" />
</head>
<body>
  <div id="nav"></div>
  <div class="container">
    <div id="err" class="err"></div>
    <h2 id="title"></h2>
    <div id="summary" class="card"></div>

    <h3>Attempts by day</h3>
    <div id="byDay"></div>

    <h3>Top students</h3>
    <div id="top"></div>
  </div>

  <script src="../assets/app.js"></script>
  <script>
    mountNav();
    requireAuth("admin");

    const id = qs("id");

    async function load() {
      document.getElementById("err").textContent = "";
      try {
        const data = await request(`/quizzes/${id}/analytics`, "GET");
        document.getElementById("title").textContent = `Analytics: ${data.quiz.title}`;
        const s = data.analytics.summary || {};
        document.getElementById("summary").innerHTML = `
          <div>Total Attempts: ${s.totalAttempts ?? 0}</div>
          <div>Avg Score: ${s.avgScore != null ? Number(s.avgScore).toFixed(2) : "0.00"}</div>
          <div>Max Score: ${s.maxScore ?? 0}</div>
          <div>Min Score: ${s.minScore ?? 0}</div>
          <div>Avg Duration: ${s.avgDuration != null ? Number(s.avgDuration).toFixed(2) : "0.00"} sec</div>
        `;

        const byDay = document.getElementById("byDay");
        byDay.innerHTML = "";
        (data.analytics.byDay || []).forEach((x) => {
          const div = document.createElement("div");
          div.className = "card";
          div.innerHTML = `<div>${x._id}</div><div>Attempts: ${x.attempts}</div><div>Avg score: ${Number(x.avgScore || 0).toFixed(2)}</div>`;
          byDay.appendChild(div);
        });

        const top = document.getElementById("top");
        top.innerHTML = "";
        (data.analytics.top || []).forEach((x) => {
          const div = document.createElement("div");
          div.className = "card";
          div.innerHTML = `<div>${x.user?.name} (${x.user?.email})</div><div>Score: ${x.score}</div><div>Duration: ${x.durationSec}s</div>`;
          top.appendChild(div);
        });
      } catch (e) {
        document.getElementById("err").textContent = e.message;
      }
    }

    load();
  </script>
</body>
</html>
